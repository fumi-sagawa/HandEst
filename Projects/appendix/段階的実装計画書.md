# HandEst 段階的実装計画書

## 1. 概要

本文書は、HandEstプロジェクトの段階的な実装アプローチを定義します。MVP（Minimum Viable Product）から最終版まで、技術的リスクを最小化しながら継続的な価値提供を行う戦略を策定します。

## 2. 段階的アプローチの理念

### 2.1 基本方針
- **早期価値提供**: 最小限の機能で早期にユーザー価値を実現
- **技術的検証**: 各段階で技術的リスクを段階的に解決
- **継続的改善**: ユーザーフィードバックに基づく品質向上
- **安定性重視**: 各段階で十分なテストと安定化を実施

### 2.2 成功指標
- 各段階での機能要件100%達成
- 全テストの通過
- 30fps以上のパフォーマンス維持
- ユーザビリティテストの合格

## 3. Phase 1: MVP（関節球・円柱モデル）

### 3.1 概要
最もシンプルな3D表現により、HandEstのコア機能を実現します。技術的な複雑さを最小限に抑え、早期のユーザーフィードバック取得を目指します。

### 3.2 実装スコープ

#### コア機能
- [ ] カメラアクセスと権限管理
- [ ] MediaPipe Handsによる21関節点検出
- [ ] 関節点を球体、骨を円柱で3D表示
- [ ] ポーズロック機能
- [ ] 基本的な3Dモデル操作（回転・拡大縮小）
- [ ] 焦点距離変更（24mm/50mm/85mm）

#### 3D表現仕様
```swift
// MVP段階の3Dモデル構成
struct SimpleHandModel {
    var joints: [SphereEntity]        // 21個の関節球
    var bones: [CylinderEntity]       // 20本の骨円柱
    var handedness: HandType          // 左右判別
}

// 関節球の仕様
class JointSphere {
    var radius: Float = 0.008         // 8mm
    var material: SimpleMaterial      // 単色マテリアル
    var color: UIColor               // 関節タイプ別の色分け
}

// 骨円柱の仕様
class BoneCylinder {
    var radius: Float = 0.004         // 4mm
    var height: Float                 // 関節間距離
    var material: SimpleMaterial      // 単色マテリアル
}
```

#### UI・UX仕様
- **メイン画面**: カメラプレビュー + 3Dオーバーレイ
- **操作方法**: タップでロック、スワイプで回転、ピンチで拡大縮小
- **フィードバック**: 認識状態の視覚的表示
- **設定**: 最小限（焦点距離選択のみ）

### 3.3 技術実装詳細

#### アーキテクチャ
```swift
// MVP段階の機能分割
struct AppFeature: Reducer {
    struct State {
        var camera: CameraFeature.State = .init()
        var handTracking: HandTrackingFeature.State = .init()
        var simpleRendering: SimpleRenderingFeature.State = .init()
    }
}

// シンプルレンダリング機能
struct SimpleRenderingFeature: Reducer {
    struct State: Equatable {
        var handModel: SimpleHandModel?
        var isLocked: Bool = false
        var transform: Transform3D = .identity
        var focalLength: FocalLength = .mm50
    }
    
    enum Action: Equatable {
        case updateHandPose([HandLandmark])
        case lockPose
        case unlockPose
        case rotate(x: Float, y: Float)
        case scale(Float)
        case changeFocalLength(FocalLength)
    }
}
```

#### RealityKit実装
```swift
class SimpleHandRenderer {
    private var handEntity: ModelEntity?
    
    func createSimpleHandModel(from landmarks: [HandLandmark]) -> ModelEntity {
        let handEntity = ModelEntity()
        
        // 関節球の作成
        for (index, landmark) in landmarks.enumerated() {
            let sphere = ModelEntity(
                mesh: .generateSphere(radius: 0.008),
                materials: [SimpleMaterial(color: jointColor(for: index), isMetallic: false)]
            )
            sphere.position = SIMD3(landmark.x, landmark.y, landmark.z)
            handEntity.addChild(sphere)
        }
        
        // 骨円柱の作成
        for connection in HandConnections.all {
            let cylinder = createBoneCylinder(from: landmarks[connection.start], to: landmarks[connection.end])
            handEntity.addChild(cylinder)
        }
        
        return handEntity
    }
}
```

### 3.4 開発スケジュール

| 週 | 主要タスク | 成果物 |
|----|------------|--------|
| 1 | プロジェクトセットアップ、TCA基盤 | 基本アーキテクチャ |
| 2 | カメラ統合、MediaPipe POC | カメラプレビュー |
| 3 | 簡易3D表示、関節点可視化 | 基本3Dモデル |
| 4 | ポーズロック、基本操作 | MVP機能完成 |
| 5 | テスト、バグ修正、最適化 | MVP版リリース |

### 3.5 品質基準
- [ ] 全自動テストの通過
- [ ] 30fps以上のフレームレート維持
- [ ] iPhone 12以降での安定動作
- [ ] カメラ権限の適切な処理
- [ ] 基本操作の直感性確認

## 4. Phase 2: 改良版（簡易メッシュモデル）

### 4.1 概要
関節球・円柱から低ポリゴンのメッシュモデルに進化させ、より手らしい表現を実現します。

### 4.2 実装スコープ

#### 新機能
- [ ] 低ポリゴン手メッシュモデル
- [ ] 基本的なスキニング（ボーンベースの変形）
- [ ] シンプルなマテリアル（色・質感）
- [ ] 改良されたUI（エフェクト選択追加）
- [ ] 画像保存機能

#### 3Dモデル仕様
```swift
struct MeshHandModel {
    var meshEntity: ModelEntity           // 低ポリゴンメッシュ
    var skeleton: [Transform3D]           // 21個のボーン変換
    var skinWeights: [VertexWeight]       // 頂点ウェイト
    var baseMaterial: PhysicallyBasedMaterial
}

// 低ポリゴンモデル仕様
class LowPolyHandMesh {
    var vertexCount: Int = 500            // 500頂点程度
    var triangleCount: Int = 1000         // 1000三角形程度
    var boneCount: Int = 21               // MediaPipeの関節数と一致
}
```

#### スキニング実装
```swift
class HandSkinner {
    func applySkining(mesh: MeshResource, landmarks: [HandLandmark]) -> ModelEntity {
        // MediaPipe関節点から変換行列を計算
        let boneTransforms = calculateBoneTransforms(from: landmarks)
        
        // スキンメッシュの変形
        let deformedMesh = applyBoneTransforms(mesh, transforms: boneTransforms)
        
        return ModelEntity(mesh: deformedMesh, materials: [handMaterial])
    }
}
```

### 4.3 アセット準備
- **3Dモデル制作**: Blenderでリグ付き低ポリゴンモデル作成
- **テクスチャ**: 512x512の基本テクスチャ
- **マテリアル**: PBRマテリアル設定
- **.reality変換**: Reality Converterでの最適化

### 4.4 開発スケジュール

| 週 | 主要タスク | 成果物 |
|----|------------|--------|
| 6 | 3Dモデル制作、アセット準備 | 低ポリゴンモデル |
| 7 | スキニングシステム実装 | メッシュ変形機能 |
| 8 | UI改良、エフェクト追加 | 改良版UI |
| 9 | 画像保存、パフォーマンス最適化 | 機能完成 |
| 10 | テスト、品質向上 | 改良版リリース |

## 5. Phase 3: 完成版（リアルスキンメッシュ）

### 5.1 概要
高品質なスキンメッシュとリアルなレンダリングにより、プロフェッショナル品質の3D手モデルを実現します。

### 5.2 実装スコープ

#### 新機能
- [ ] 高品質スキンメッシュモデル
- [ ] リアルなマテリアル（肌質感、法線マップ）
- [ ] 高度なライティング
- [ ] 特殊エフェクト（魚眼、平行投影）
- [ ] 設定メニューの充実
- [ ] アクセシビリティ対応

#### 高品質モデル仕様
```swift
struct RealisticHandModel {
    var highPolyMesh: ModelEntity         // 高ポリゴンメッシュ
    var detailedSkeleton: [Transform3D]   // 詳細ボーン
    var skinTexture: TextureResource      // 肌テクスチャ
    var normalMap: TextureResource        // 法線マップ
    var subsurfaceScattering: Bool        // サブサーフェススキャッタリング
}

// 高品質モデル仕様
class HighQualityHandMesh {
    var vertexCount: Int = 2000           // 2000頂点
    var triangleCount: Int = 4000         // 4000三角形
    var textureResolution: Int = 1024     // 1024x1024テクスチャ
    var lodLevels: Int = 3                // LOD対応
}
```

#### 高度なレンダリング
```swift
class RealisticHandRenderer {
    func createRealisticMaterial() -> PhysicallyBasedMaterial {
        var material = PhysicallyBasedMaterial()
        material.baseColor = .init(tint: skinColor, texture: .init(skinTexture))
        material.normal = .init(texture: .init(normalMap))
        material.roughness = .init(floatLiteral: 0.7)
        material.subsurface = .init(floatLiteral: 0.3)
        return material
    }
    
    func setupAdvancedLighting() -> [Entity] {
        // 3点照明の設定
        let keyLight = PointLight()
        let fillLight = PointLight()
        let rimLight = PointLight()
        
        return [keyLight, fillLight, rimLight]
    }
}
```

### 5.3 開発スケジュール

| 週 | 主要タスク | 成果物 |
|----|------------|--------|
| 11-12 | 高品質3Dモデル制作 | リアルメッシュ |
| 13 | 高度なマテリアル実装 | リアルレンダリング |
| 14 | 特殊エフェクト実装 | 全機能完成 |
| 15 | 設定メニュー、アクセシビリティ | UI完成 |
| 16-17 | 総合テスト、最適化 | 最終版 |

## 6. 技術的課題と対応策

### 6.1 共通課題

#### パフォーマンス維持
- **課題**: 高品質化によるフレームレート低下
- **対策**: LOD（Level of Detail）システム実装
- **実装**: 距離・デバイス性能に応じた自動品質調整

#### メモリ管理
- **課題**: 高解像度テクスチャによるメモリ圧迫
- **対策**: テクスチャストリーミング、圧縮形式活用
- **実装**: iOS Metal Performance Shadersの活用

### 6.2 各Phase固有課題

#### Phase 1課題
- MediaPipe統合の安定性 → 十分なテスト期間確保
- TCA学習コスト → プロトタイプでの習熟

#### Phase 2課題
- スキニング精度 → 専門知識の習得、外部協力
- アセット制作 → 3Dアーティストとの連携

#### Phase 3課題
- レンダリング品質 → Metal Shadingの深い理解
- パフォーマンス最適化 → Instruments活用した詳細分析

## 7. 品質保証戦略

### 7.1 各Phase共通
- [ ] 自動テストの100%通過
- [ ] パフォーマンステストの合格
- [ ] 複数デバイスでの動作確認
- [ ] アクセシビリティガイドライン準拠

### 7.2 Phase別品質基準

#### Phase 1
- [ ] 基本機能の動作確認
- [ ] 30fps維持
- [ ] メモリリークなし

#### Phase 2
- [ ] メッシュ変形の自然さ
- [ ] UI操作の直感性
- [ ] 画像保存機能の正常動作

#### Phase 3
- [ ] レンダリング品質
- [ ] 全機能の統合動作
- [ ] App Store審査準備完了

## 8. リリース戦略

### 8.1 段階的リリース
- **MVP Beta**: 内部テスト、技術検証
- **改良版 TestFlight**: 限定ユーザーテスト
- **完成版 App Store**: 一般公開

### 8.2 フィードバック収集
- アプリ内フィードバック機能
- TestFlightコメント分析
- ユーザビリティテスト実施

---

*文書作成日: 2025-05-28*
*最終更新日: 2025-05-28*