# タスク名: MediaPipe Handsの統合と基本的な手認識

## 概要
MediaPipe Handsフレームワークを統合し、カメラ映像から手の21個の関節点をリアルタイムで検出する機能を実装する。iOS環境での制限を考慮した実装を行う。

## 背景・目的
- 手の3Dモデル化のための関節点データ取得
- リアルタイム（30fps以上）での手認識実現
- 左右の手の判別機能の実装

## 優先度
**High** - アプリのコア機能である手認識の実装

## 前提条件
- #003（カメラアクセス）が完了していること

## To-Be（完了条件）

### フェーズ1: 環境セットアップと基盤実装
- [ ] MediaPipe iOS frameworkの調査と統合方法決定
- [ ] 依存関係の追加（CocoaPods/SPM/手動統合）
- [ ] ライセンス表記の追加（Apache License 2.0）
- [ ] プロジェクトビルド確認
- [ ] バイナリサイズへの影響確認（50-100MB想定）

### フェーズ2: データモデル定義
- [ ] HandLandmark構造体の実装（座標、信頼度）
- [ ] HandPose構造体の実装（21関節点のコレクション）
- [ ] HandednessData構造体の実装（左右判別データ）
- [ ] MediaPipeError列挙型の実装
- [ ] データモデルの単体テスト作成

### フェーズ3: MediaPipeClient実装（基本）
- [ ] MediaPipeClientプロトコル定義
- [ ] HandLandmarkerの初期化処理実装
- [ ] 基本的なフレーム処理メソッド実装
- [ ] 初期化エラーハンドリング実装
- [ ] MediaPipeClientの基本テスト作成

### フェーズ4: MediaPipeClient実装（詳細）
- [ ] 21個の関節点データの取得と変換実装
- [ ] 3D座標データ（x,y,z）の処理実装
- [ ] 左右の手の判別機能実装（信頼度閾値0.8以上）
- [ ] 非同期処理とコールバック実装
- [ ] MediaPipeClientの詳細テスト作成

### フェーズ5: HandTrackingFeature実装
- [ ] HandTrackingFeature State定義
- [ ] HandTrackingFeature Action定義
- [ ] HandTrackingFeature Reducer実装
- [ ] MediaPipeClientとの統合
- [ ] HandTrackingFeatureの単体テスト作成

### フェーズ6: エラーハンドリングと最適化
- [ ] 認識失敗時のエラーハンドリング（Logger使用）
- [ ] 低照度環境の検出と警告実装
- [ ] パフォーマンス最適化（処理キュー管理）
- [ ] メモリ使用量の監視実装
- [ ] エラーケースの網羅的テスト作成

### フェーズ7: 動作検証と最終調整
- [ ] 認識精度と速度の検証（30fps維持）
- [ ] フォールバック処理の実装と検証
- [ ] 実機での動作確認（手の認識、FPS測定）
- [ ] 統合テストの実行
- [ ] パフォーマンステスト実行
- [ ] 全テスト通過確認

## 実装方針

### 段階的実装アプローチ
各フェーズを順番に実装し、フェーズ完了毎にテストを実行して動作確認を行う。

### 技術選択と統合方法
1. **MediaPipe統合方法**
   - 第一選択: Swift Package Manager（利用可能な場合）
   - 第二選択: CocoaPods統合
   - 最終手段: 手動でのフレームワーク追加
   - ライセンス表記: Apache License 2.0の追加

2. **アーキテクチャ設計**
   ```swift
   // データモデル階層
   HandLandmark (座標+信頼度)
   ↓
   HandPose (21個のランドマーク)
   ↓
   HandTrackingResult (両手+メタデータ)
   
   // 依存関係
   MediaPipeClient (プロトコル)
   ↓
   HandTrackingFeature (TCA Reducer)
   ↓
   HandTrackingView (SwiftUI)
   ```

3. **パフォーマンス戦略**
   - バックグラウンドキューでMediaPipe処理
   - メインキューでUI更新
   - フレームドロップ対応（30fps維持優先）
   - メモリプレッシャー監視

4. **エラーハンドリング戦略**
   - 初期化エラー: アプリ起動時の明確なエラー表示
   - 処理エラー: ログ記録 + フォールバック
   - パフォーマンス劣化: 品質調整 + ユーザー通知

### 各フェーズの実装詳細

#### フェーズ1: 統合検証
- MediaPipeの最新版との互換性確認
- Xcodeプロジェクトでのビルド成功
- 基本的な初期化テスト

#### フェーズ2: 型安全なデータモデル
- Swift Codableプロトコル準拠
- 座標系の統一（正規化座標 0.0-1.0）
- 信頼度スコアの適切な閾値設定

#### フェーズ3-4: 段階的Client実装
- テスト駆動開発（TDD）でプロトコル実装
- モック使用での単体テスト
- 実際のMediaPipeとの統合テスト

#### フェーズ5: TCA統合
- State/Action/Reducerの明確な分離
- 非同期処理のEffect管理
- テスタブルな設計

#### フェーズ6-7: 品質担保
- エッジケース網羅
- パフォーマンステスト自動化
- 実機での総合テスト

## リスクと対策
- **iOS環境での安定性**: 定期的なライブラリ更新への対応
- **バイナリサイズ**: On-Demand Resourcesの検討
- **認識精度**: 低照度環境での警告表示

## 関連情報
- 前提タスク: #003（カメラアクセス）
- MediaPipe公式ドキュメント: https://developers.google.com/mediapipe
- 機能要件仕様書: 3.1 手のポーズデータ、7.2 MediaPipe実装における注意事項

## 作業ログ

### 2025-05-28 15:30 - チケットブラッシュアップ完了
- **実施内容**: 
  - 大きなタスクを7つのフェーズに分解
  - 各フェーズで具体的なサブタスクを定義
  - 段階的実装アプローチを明確化
  - テスト駆動開発のフローを組み込み
- **変更点**:
  - To-Be条件を7フェーズに構造化
  - 実装方針に技術選択と詳細戦略を追加
  - 各フェーズの完了条件を明確化
- **次のアクション**: 
  - フェーズ1から順次実装開始
  - MediaPipe統合方法の調査・決定
  - ユーザー承認後に作業開始