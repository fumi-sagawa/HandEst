# タスク名: 簡易3Dモデル（関節球と円柱）の表示 - MVP Phase 1

## 概要
MediaPipeで取得した手の関節点データを基に、RealityKitを使用して関節を球体、骨を円柱で表現する簡易的な3Dモデルを表示する。段階的実装のPhase 1として位置づける。

## サブチケット
このタスクは以下の4つのサブチケットに分解されています：

1. **[005-01-realitykit-setup](../todo/005-01-realitykit-setup.md)** - RealityKit基盤構築
   - RealityKitのセットアップと基本実装
   - RenderingFeatureの基本構造
   - 座標系変換処理

2. **[005-02-3d-model-rendering](../todo/005-02-3d-model-rendering.md)** - 3Dモデル表示実装
   - 球体・円柱によるモデル生成
   - リアルタイム更新処理
   - パフォーマンス最適化

3. **[005-03-camera-integration](../todo/005-03-camera-integration.md)** - カメラ映像統合
   - 背景フィルター処理
   - RealityKitとの統合

4. **[005-04-error-handling-tests](../todo/005-04-error-handling-tests.md)** - エラーハンドリング・テスト
   - 包括的なエラー処理
   - テストスイート作成
   - 実機動作確認

## 背景・目的
- MVPとして早期に動作する3D表示の実現
- リアルな3Dモデル実装前の技術検証
- 基本的な3D操作機能の土台作り

## 優先度
**High** - MVPの中核機能として必須

## 前提条件
- #004（MediaPipe統合）が完了していること

## To-Be（完了条件）
- [ ] RealityKitのセットアップと基本実装
- [ ] RenderingFeatureの実装
- [ ] 関節点への球体配置（21個）
- [ ] 関節間の円柱による接続
- [ ] 手のひら部分の簡易メッシュ表示
- [ ] 3Dモデルの更新処理（30fps維持）
- [ ] 背景のカメラ映像処理（グレースケール＋ブラー）
- [ ] 座標系の適切な変換実装
- [ ] RealityKit初期化エラーの処理
- [ ] レンダリングエラーのハンドリング（Logger使用）
- [ ] メモリ不足時の対処
- [ ] RenderingFeatureの単体テスト
- [ ] パフォーマンステストの作成
- [ ] 実機での動作確認
- [ ] テストが全て通る
- [ ] ドキュメント更新完了

## 実装方針
1. RealityKitのARViewセットアップ
   - SwiftUIでのRealityKitView実装（ARViewではなくRealityView）
   - カメラ映像の背景処理（リアルタイムフィルター）
   - シーンの基本構成
2. 3Dエンティティの生成
   - ModelEntityで球体（半径5mm）と円柱を作成
   - シンプルなマテリアル（白色、少し透明度）
   - 基本的なライティング設定
3. 座標変換とスケーリング
   - MediaPipe座標系（0-1正規化）からRealityKit座標系へ
   - 手のサイズを画面に収まるよう調整
   - z座標（深度）の適切なマッピング
4. リアルタイム更新
   - エンティティプールによる効率化
   - 毎フレームの位置更新処理
   - メモリリークの防止（weak参照）

## 段階的実装の位置づけ
- **Phase 1（本タスク）**: 球体と円柱による簡易表現
- **Phase 2（将来）**: 簡易的なメッシュモデル
- **Phase 3（将来）**: リアルなスキンメッシュ

## 関連情報
- 前提タスク: #004（MediaPipe統合）
- RealityKit公式ドキュメント
- 機能要件仕様書: 4.2.2 3Dモデルの生成、7.1 リアルな3Dモデル実装

## 作業ログ
### 2025-05-29 11:30
- タスク開始、ブランチ作成: feature/005-simple-3d-model-display
- アジャイル開発の観点から設計を分析

**分析結果: ✅ アジャイル開発として妥当な設計**

1. **段階的リリースが可能**
   - Phase 1: 球体・円柱で素早くMVPを実現
   - Phase 2: 簡易メッシュで品質向上
   - Phase 3: リアルモデルで最終品質

2. **モデル差し替えの容易性**
   - HandModelProviderプロトコルで抽象化することで差し替えを容易に
   - 依存性注入により、テスト時のモック化も容易

3. **後続タスクとの整合性**
   - ポーズロック: モデル形状に依存しない設計
   - 回転・拡大: 手の重心を基準にするため、モデル形状不問
   - 変換処理: RenderingFeatureで一元管理

4. **リスク軽減**
   - 早期に3D表示を実現し、技術的課題を発見
   - パフォーマンス問題を段階的に解決
   - ユーザーフィードバックを早期に獲得

**推奨実装方針**:
```swift
protocol HandModelProvider {
    func createHandModel() -> ModelEntity
    func updateHandModel(_ model: ModelEntity, with landmarks: [HandLandmark])
}

enum ModelType {
    case simple      // 球体・円柱
    case mesh        // 簡易メッシュ
    case realistic   // リアルモデル
}
```

後でUSDZファイルやglTFモデルをインポートする際も、HandModelProviderの実装を追加するだけで対応可能。

### 2025-05-29 11:45
- タスクの規模が大きいため、4つのサブチケットに分解
- サブチケット作成完了：
  - 005-01: RealityKit基盤構築
  - 005-02: 3Dモデル表示実装
  - 005-03: カメラ映像統合
  - 005-04: エラーハンドリング・テスト
- 段階的な実装により、各機能を独立してテスト可能に