/Users/fumiyasagawa/Development/fumiya/HandEst./Projects/Hand Estデザインイメージ.png

## 1. アプリケーション概要

### 1.1 アプリケーションの目的

Hand Estimatorは、イラストレーターや漫画家が手を描く際の参考資料として使用するiOSアプリケーションです。ユーザーが自分の手をカメラにかざすと、リアルタイムで3Dモデル化され、様々な焦点距離やエフェクトを適用して観察できます。

### 1.2 主要な特徴

- **リアルタイム3D変換**: カメラに映した手を即座に3Dモデルとして表示
- **焦点距離の自由な変更**: 24mm、50mm、85mmの3つの焦点距離を切り替え可能
- **ポーズの固定機能**: 気に入ったポーズをロックして、じっくり観察
- **特殊効果**: 魚眼効果や平行投影など、通常のカメラでは実現できない表現

### 1.3 動作環境

- **プラットフォーム**: iOS 15.0以上
- **対応デバイス**: iPhone X以降、iPad（第6世代）以降
- **必要なハードウェア**: フロントカメラまたはリアカメラ
- **ネットワーク**: 不要（完全オフライン動作）

---

## 2. 技術アーキテクチャ

### 2.1 採用技術スタック

#### 2.1.1 フレームワーク構成

- **UI層**: SwiftUI（宣言的UIによる画面構築）
- **3Dレンダリング**: RealityKit（Appleの最新3Dフレームワーク）
- **手認識**: MediaPipe Hands（Googleの機械学習ベース手認識ライブラリ）
- **カメラ制御**: AVFoundation（低レベルカメラアクセス）
- **アーキテクチャ**: The Composable Architecture（状態管理とビジネスロジック）

#### 2.1.2 選定理由

**MediaPipe Handsの採用理由**:

- x, y座標に加えて、実際の深度情報（z座標）を取得可能
- 21個の関節点を高精度で認識（平均誤差約10mm）
- iOSネイティブサポートあり
- リアルタイム処理に最適化

**RealityKitの採用理由**:

- Metal最適化による高速レンダリング
- 簡単な3Dシーン構築
- カメラ投影方式の柔軟な制御

### 2.2 システム構成

アプリケーションは以下の3つのレイヤーで構成されます：

1. **背景層**: カメラ映像（グレースケール＋ブラー処理）
2. **前景層**: 3D手モデルのレンダリング
3. **UI層**: 操作コントロールとフィードバック表示

---

## 3. データモデル

### 3.1 手のポーズデータ

#### 3.1.1 HandPose（手の姿勢情報）

手の認識結果を表現するデータ構造：

- **識別子**: 各認識結果の一意のID
- **タイムスタンプ**: 認識時刻
- **関節点リスト**: 21個の関節点の3次元座標
- **信頼度**: 認識の確からしさ（0.0〜1.0）

#### 3.1.2 HandLandmark（関節点情報）

各関節点の詳細情報：

- **関節タイプ**: 手首、親指、人差し指など21種類
- **3D座標**: x, y, z座標（zは手首を基準とした深度）
- **可視性**: その関節が見えているかの確率
#### 3.1.3 HandednessData（手の左右情報）

MediaPipeから取得する左右判別データ：

- **判別結果**: LEFT（左手）またはRIGHT（右手）
- **信頼度スコア**: 0.0〜1.0の判別確信度
- **表示ラベル**: 日本語表示用の「左手」「右手」文字列

### 3.2 カメラ設定データ

#### 3.2.1 CameraSettings

現在のカメラ状態を管理：

- **焦点距離**: 24mm、50mm、85mmのいずれか
- **ロック状態**: ポーズが固定されているか
- **投影方式**: 透視投影または平行投影
- **エフェクト設定**: 魚眼効果のオン/オフと強度

### 3.3 ユーザー設定データ

アプリケーションの設定情報：

- **初回起動フラグ**: チュートリアル表示の制御
- **デフォルト焦点距離**: 起動時の焦点距離
- **触覚フィードバック**: 振動の有効/無効
- **自動サイズ調整**: 焦点距離変更時のサイズ維持機能

---

## 4. 機能仕様詳細

### 4.1 アプリケーション起動時の動作

#### 4.1.1 初回起動時

1. スプラッシュ画面を0.5秒表示
2. カメラ使用許可のダイアログを表示
3. 許可された場合、簡単なチュートリアルを表示（3画面）
4. メイン画面に遷移

#### 4.1.2 2回目以降の起動

1. スプラッシュ画面を0.5秒表示
2. 前回の設定（焦点距離など）を復元
3. カメラプレビューを開始
4. 手の認識を自動的に開始

### 4.2 手の認識と3D表示

#### 4.2.1 認識プロセス

1. **カメラ映像の取得**: 30fpsでフレームを取得
2. **MediaPipeによる処理**: 各フレームで手の関節点を検出
3. **3D座標の生成**: 21個の関節点のx, y, z座標を計算
4. **モデルの更新**: 3Dモデルの各関節位置を更新

#### 4.2.2 3Dモデルの生成

認識された関節点を基に、以下の要素で3Dモデルを構築：

- **関節**: 各関節点に小さな球体を配置
- **骨**: 関節間を円柱で接続
- **手のひら**: 手首と各指の付け根を結ぶメッシュ

#### 4.2.3 背景処理

カメラ映像は以下の処理を経て背景として表示：

1. リアルタイムでグレースケール変換
2. ガウシアンブラー（半径10ピクセル）を適用
3. 半透明のオーバーレイで暗く調整

#### 4.2.4 左右の手の判別機能

MediaPipe Handsの手の左右判別機能を活用し、以下の機能を実装：

**判別機能**:

- **自動判別**: MediaPipeが提供する handedness（利き手情報）を使用して右手・左手を自動識別
- **表示インジケーター**: 画面上部に現在認識している手の種類を表示（「右手」または「左手」）
- **切り替え対応**: ユーザーが手を入れ替えた場合、自動的に検出して表示を更新
- 判定ができなかった場合基本的に前の判定結果を引き続き使用する。

### 4.2.5 リアルな3Dハンドモデルの表示と変形
**モデルの仕組み**:
- **事前準備**: リグ（骨格）入りの3Dハンドモデルを事前に用意
- **関節点のマッピング**: MediaPipeが検出した21個の関節点を、3Dモデルのボーンに対応付け
- **リアルタイム変形**: 検出された関節位置に基づいてボーンを回転・移動させ、メッシュを変形
**処理フロー**:
1. MediaPipeが手の関節点を検出
2. 検出された関節点の位置をボーンの位置・回転に変換
3. ボーンの動きに応じてスキンメッシュが自動的に変形
4. 変形後のモデルをレンダリング

### 4.3 ポーズロック機能

#### 4.3.1 ロック時の動作

1. ロックボタン（カメラアイコン）をタップ
2. 現在の手のポーズを内部に保存
3. カメラプレビューをフェードアウト（0.3秒）
4. 背景を黒に変更
5. ボタンアイコンをロック状態（鍵アイコン）に変更
6. 3Dモデルの回転・拡大縮小操作を有効化

#### 4.3.2 アンロック時の動作

1. ロックボタンを再度タップ
2. カメラプレビューをフェードイン（0.3秒）
3. リアルタイム認識を再開
4. ボタンアイコンを通常状態に戻す

### 4.4 3Dモデル操作

#### 4.4.1 回転操作の詳細

- **操作方法**: 1本指でスワイプ
- **横スワイプ**: Y軸を中心に水平回転（左右360度）
- **縦スワイプ**: X軸を中心に垂直回転（上下180度）
- **感度**: スワイプ距離に比例（1ピクセル = 0.5度）
- **制限**: なし（自由に回転可能）

#### 4.4.2 拡大縮小操作の詳細

- **操作方法**: 2本指でピンチイン/アウト
- **拡大率**: 0.5倍〜3.0倍
- **中心点**: 2本指の中間点を基準
- **アニメーション**: スムーズに追従（慣性なし）

### 4.5 焦点距離変更機能

#### 4.5.1 焦点距離による見え方の違い

**24mm（広角）**:

- 視野角84度の広い画角
- 手前の指が大きく、奥の部分が小さく見える
- ダイナミックで迫力のある表現
- カメラを近づけて撮影したような効果

**50mm（標準）**:

- 視野角46度の自然な画角
- 人間の目で見た感覚に近い
- バランスの取れた遠近感

**85mm（望遠）**:

- 視野角28度の狭い画角
- 遠近感が圧縮され、平面的に見える
- 各指の大きさの差が小さい
- 離れた位置から撮影したような効果

**F.E.（Fish Eye）**:

- 魚眼レンズ特有の球面歪みを適用
- 中心から離れるほど歪みが強くなる
- より広い範囲を一度に表示可能
- 画面中央の手は比較的歪みが少なく、画面端に近い部分は大きく湾曲

**P.P.（Parallel Projection）**:

- 平行投影による表現（奥行きによるサイズ変化なし）
- 手前と奥の指が同じ太さに見える
- 設計図や図面のような表現
- 正確な形状把握に適している

#### 4.5.2 自動サイズ調整機能

焦点距離を変更しても、手のモデルが画面内で同じ大きさを維持するよう、カメラの距離を自動調整：

- 24mm選択時：カメラを0.55倍の距離に移動
- 50mm選択時：基準距離（1.0倍）
- 85mm選択時：カメラを1.7倍の距離に移動
- F.E.選択時：基準距離で魚眼効果を適用
- P.P.選択時：基準距離で平行投影を適用

### 4.7 画像保存機能

#### 4.7.1 保存プロセス

1. 画面右下部のダウンロードボタンをタップ
2. 現在の3Dビューをキャプチャ
3. UI要素を除外した画像を生成
4. カメラロールへの保存許可を確認（初回のみ）
5. 保存完了の触覚フィードバック

#### 4.7.2 保存される画像の仕様

- **解像度**: デバイスの画面解像度と同じ
- **形式**: JPEG（品質90%）
- **内容**: 3Dモデルと背景のみ（UIは含まない）

### 4.8 メニュー機能（簡略版）

#### 4.8.1 メニューの表示

#### 動作仕様
1. 左下のメニューボタン（ハンバーガーアイコン）をタップ
2. 画面下部からモーダルシートが上にスライド表示
3. 背景は半透明のオーバーレイで覆われる
4. メニュー外のタップまたは下スワイプで閉じる

#### 表示スタイル
- **表示方法**: iOS標準のモーダルシート（.sheet）
- **高さ**: コンテンツに応じて自動調整
- **角丸**: 上部のみ角丸（半径16pt）
- **背景**: ブラー効果付きの半透明

### 4.8.2 メニュー項目
#### 設定
- アイコン: gearshape
- タップ時: 設定画面を表示
- 設定項目:
    - デフォルト焦点距離（24mm/50mm/85mm）
    - 触覚フィードバックのオン/オフ
#### 利用規約
- アイコン: doc.text
- タップ時: 利用規約を表示（Webビューまたはテキストビュー）
#### プライバシーポリシー
- アイコン: hand.raised
- タップ時: プライバシーポリシーを表示（Webビューまたはテキストビュー）
#### レビューを書く
- アイコン: star
- タップ時: App Storeのレビュー画面を開く
#### このアプリをシェア
- アイコン: square.and.arrow.up
- タップ時: 共有シートを表示（アプリのダウンロードリンク）
### 4.8.3 メニューのレイアウト
```
┌─────────────────────────────────────┐
│         ━━━━━━━━━━━━━━━             │ ← ハンドルバー
├─────────────────────────────────────┤
│  ⚙️  設定                           │
│  ─────────────────────────────────  │
│  📄  利用規約                       │
│  ─────────────────────────────────  │
│  🤚  プライバシーポリシー            │
│  ─────────────────────────────────  │
│  ⭐  レビューを書く                  │
│  ─────────────────────────────────  │
│  ↗️  このアプリをシェア              │
└─────────────────────────────────────┘
```
### 4.8.4 設定画面の詳細
#### レイアウト
```
┌─────────────────────────────────────┐
│  ＜ 戻る          設定              │
├─────────────────────────────────────┤
│                                     │
│  デフォルト焦点距離                  │
│  [24mm] [50mm] [85mm]              │ ← セグメントコントロール
│                                     │
│  触覚フィードバック        [ON/OFF]  │ ← トグルスイッチ
│                                     │
└─────────────────────────────────────┘
```
#### 動作仕様
- 設定変更は即座に保存（UserDefaults使用）
- 焦点距離の変更は次回起動時から適用
- 触覚フィードバックは即座に反映
### 4.8.5 実装上の注意点
1. **シンプルな構成**
    - 必要最小限の項目のみ
    - 将来的な拡張を考慮した設計
2. **法的要件の遵守**
    - 利用規約とプライバシーポリシーは必須
    - App Store審査要件を満たす
3. **ユーザビリティ**
    - タップ領域は44x44pt以上
    - 項目間に適切な余白
    - 視覚的な区切り線で見やすく

## 5. 画面遷移と状態管理
### 5.1 画面構成

アプリケーションは基本的に単一画面で構成：

1. **メイン画面**: すべての機能を含む
2. **設定モーダル**: ヘルプボタンから表示（オーバーレイ）
3. **エラーダイアログ**: 必要に応じて表示

### 5.2 状態遷移

#### 5.2.1 認識状態

1. **待機中**: カメラは起動しているが手を検出していない
2. **認識中**: 手を検出し、リアルタイムで3Dモデルを更新
3. **ロック中**: ポーズを固定し、操作可能な状態

#### 5.2.2 状態遷移のルール

- 待機中 → 認識中：手がカメラに映ると自動遷移
- 認識中 → 待機中：手がフレームアウトすると自動遷移
- 認識中 → ロック中：ロックボタンタップ
- ロック中 → 認識中：ロックボタン再タップ

---

## 6. エラー処理とフィードバック

### 6.1 エラーケース

#### 6.1.1 カメラ関連

- **カメラ権限拒否**: 設定画面への誘導メッセージを表示
- **カメラ初期化失敗**: デバイスの再起動を促すメッセージ

#### 6.1.2 認識関連

- **低照度環境**: 「明るい場所で使用してください」と表示
- **手が遠すぎる**: 「手を近づけてください」と表示
- **手が近すぎる**: 「手を離してください」と表示
- **認識失敗**: 「手をゆっくり動かしてください」と表示

### 6.2 ユーザーフィードバック

#### 6.2.1 視覚的フィードバック

- **認識成功**: 3Dモデルの表示開始
- **ロック状態**: ボタンアイコンの変更、背景の変化
- **焦点距離変更**: スムーズなアニメーション遷移
- **エフェクト適用**: ボタンの色変更（オレンジ色）

#### 6.2.2 触覚フィードバック

- **ボタンタップ**: 軽い振動（UIImpactFeedbackGenerator.light）
- **ロック成功**: 中程度の振動（UIImpactFeedbackGenerator.medium）
- **エラー発生**: 強い振動（UINotificationFeedbackGenerator.error）

## 7. 技術実装上の注意事項
### 7.1 リアルな3Dモデル実装における技術的考慮事項
#### 7.1.1 実現可能性
現在の技術スタック（RealityKit + MediaPipe）でリアルな3Dハンドモデルの実装は技術的に可能ですが、以下の点に注意が必要です：
**可能な部分**:
- RealityKitは`.usdz`形式でリグ付きモデルをサポート
- `ModelEntity`でスキンメッシュアニメーションに対応
- MediaPipeの21関節点データ（3D座標）を取得可能
**課題と対策**:
1. **ボーンマッピングの実装**
	- MediaPipeの関節点とモデルのボーン構造の対応付けが必要
	- カスタムマッピングロジックの実装が必須
2. **パフォーマンスの確保**
	- 30fpsでのスムーズな変形処理を維持
	- 必要に応じてモデルのポリゴン数を調整
3. **実装の複雑さ**
	   - リグとウェイト設定済み3Dモデルの事前準備が必要
	   - Blender等で作成したモデルを`.reality`ファイルとして組み込み
#### 7.1.2 段階的な実装アプローチ
技術的リスクを最小限に抑えるため、以下の段階的アプローチを推奨：
1. **Phase 1（MVP）**: 関節球と円柱による簡易表現
	- 実装が簡単で、基本機能の検証が可能
	- パフォーマンスが安定
2. **Phase 2（改良版）**: 簡易的なメッシュモデル
	 - 低ポリゴンのハンドモデルを使用
	 - 基本的なスキニングの実装
3. **Phase 3（完成版）**: リアルなスキンメッシュ
	  - 高品質な3Dモデルの適用
	  - 詳細なテクスチャとマテリアルの実装
この段階的アプローチにより、早期にMVPをリリースし、ユーザーフィードバックを得ながら品質を向上させることができます。

### 7.2 MediaPipe実装における注意事項
#### 7.2.1 iOS環境での制限
**ライブラリの統合**:
- MediaPipe iOSフレームワークのバイナリサイズが大きい（約50-100MB）
- App Storeの初回ダウンロードサイズ制限（200MB）に注意
- 必要に応じてOn-Demand Resourcesの活用を検討
**実装の安定性**:
- iOS向けMediaPipeは比較的新しく、Androidほど成熟していない
- 定期的なライブラリ更新による破壊的変更の可能性
- フォールバック処理の実装が必須
**ライセンス要件**:
- MediaPipeはApache License 2.0
- アプリ内でのライセンス表記が必要
- 商用利用は問題ないが、適切なクレジット表記を確認

### 7.3 3Dモデル関連の考慮事項
#### 7.3.1 モデルアセットの準備
**左右の手の対応**:
- 左手用と右手用で別々のモデルが必要
- または、右手モデルをミラーリングする実装
- ミラーリング時のテクスチャ（ほくろ等）の考慮
**モデルの権利関係**:
- 3Dモデルの著作権・使用権の確保
- 商用利用可能なモデルの選定または自作
- モデル制作を外注する場合の権利譲渡契約
**ファイルサイズ最適化**:
- 高品質モデルは1つあたり5-10MB程度
- 左右分と複数の品質レベルで合計30-50MB
- アプリサイズへの影響を考慮

### 7.4 パフォーマンスとバッテリー

#### 7.4.1 処理負荷の管理
**CPU/GPU使用率**:
- MediaPipeの推論処理 + RealityKitのレンダリング
- 継続使用で60-80%のCPU使用率が予想される
- サーマルスロットリング対策が必要
**バッテリー消費**:
- カメラ + ML推論 + 3Dレンダリングの組み合わせ
- 15-20分の使用で10-15%のバッテリー消費見込み
- 省電力モードの実装を検討
**発熱対策**:
- 長時間使用時の発熱警告表示
- 自動的な品質低下による負荷軽減
- 一定温度での強制休止機能

### 7.5 エッジケースとエラー処理

#### 7.5.1 認識に関する特殊ケース
**複数の手の処理**:
- MediaPipeは複数の手を検出可能
- どの手を優先するかのロジックが必要
- 画面中央に最も近い手を選択する実装

#### 7.5.2 境界条件
**手の位置**:
- 画面端で手が切れる場合の処理
- 部分的にしか見えない手の扱い
- カメラに近すぎる/遠すぎる場合の警告
**照明条件**:
- 極端な逆光での認識精度低下
- 暗所での最低照度要件（50ルクス以上推奨）
- 赤外線カメラ非対応デバイスでの制限

### 7.6 App Store審査対策
#### 7.6.1 審査ガイドライン準拠
**カメラ使用の正当性**:
- 手の3D化という明確な用途の説明
- カメラ使用理由の詳細な記載
- 録画機能がないことの明記
**プライバシー対応**:
- カメラ映像を保存・送信しないことの保証
- Privacy Nutritionラベルの正確な記載
- 子供向けではないことの明確化
**コンテンツレーティング**:
- 4+ (誰でも利用可能)での申請
- 教育カテゴリでの登録を検討
- 不適切なコンテンツが生成されないことの説明

### 7.7 開発リソースとスケジュール
#### 7.7.1 必要な専門性
**3Dモデリング**:
- プロフェッショナルな3Dアーティストが必要
- リグ設定とウェイトペイントの専門知識
- 2-3週間のモデル制作期間
**MediaPipe統合**:
- 機械学習エンジニアまたは経験者が望ましい
- iOS特有の実装課題への対応力
- 1-2ヶ月の学習・実装期間

#### 7.7.2 リスク軽減策
**プロトタイプ開発**:
- 技術検証用の簡易版を先行開発
- 主要な技術課題の早期発見
- 2-3週間でのPOC完成を目標
**代替技術の検討**:
- Vision Frameworkへのフォールバック案
- ARKitのハンドトラッキング（iOS 16以降）
- 独自の簡易認識アルゴリズム
