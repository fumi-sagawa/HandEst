#!/bin/bash

echo "ğŸ” Running pre-commit checks..."

# ã‚ˆã‚Šé«˜é€Ÿãªãƒ“ãƒ«ãƒ‰è¨­å®šã‚’ä½¿ç”¨
DESTINATION='platform=iOS Simulator,name=iPhone 16'
BUILD_SETTINGS="-parallelizeTargets -jobs 8"
TEST_SETTINGS="-parallel-testing-enabled YES -maximum-concurrent-test-simulator-destinations 4"

# ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã‚’å¿…ãšå®Ÿè¡Œï¼ˆä¸¦åˆ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
echo "ğŸ§ª Running tests and build..."
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã®ã¿è¡¨ç¤ºã™ã‚‹æ–°ã—ã„æ–¹å¼ï¼‰
if xcodebuild -scheme HandEst -destination "$DESTINATION" $BUILD_SETTINGS $TEST_SETTINGS test -quiet 2>&1 | tee test_output.log | grep -E "(error:|failed:|TEST FAILED|âœ—)"; then
    echo "âŒ Tests or build failed! Please fix the issues before committing."
    rm -f test_output.log
    exit 1
else
    echo "âœ… All tests passed!"
    rm -f test_output.log
fi

# SwiftLintãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã®ã¿è¡¨ç¤ºï¼‰
echo "ğŸ§¹ Running SwiftLint checks..."
if swiftlint lint --quiet 2>&1 | grep "error:"; then
    echo "âŒ SwiftLint errors found! Please fix the issues before committing."
    exit 1
else
    echo "âœ… No lint errors!"
fi

# ç´”ç²‹é–¢æ•°ã¨Reducerã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
echo "ğŸ“Š Checking test coverage for pure functions and Reducers..."
if ! ./Scripts/check-test-coverage.swift; then
    echo ""
    echo "âš ï¸  è­¦å‘Š: ç´”ç²‹é–¢æ•°ã¾ãŸã¯Reducerã®ãƒ†ã‚¹ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™"
    echo ""
    echo "TCAã®åŸå‰‡ã«å¾“ã„ã€ä»¥ä¸‹ã¯å¿…ãšãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„:"
    echo "  - Reducerã®reduceãƒ¡ã‚½ãƒƒãƒ‰"
    echo "  - public/internalãªç´”ç²‹é–¢æ•°"
    echo "  - å‰¯ä½œç”¨ã®ãªã„è¨ˆç®—å‡¦ç†"
    echo ""
    echo "ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å ´åˆã¯ --no-verify ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:"
    echo "  git commit --no-verify -m 'WIP: ãƒ†ã‚¹ãƒˆè¿½åŠ äºˆå®š'"
    echo ""
    exit 1
fi

echo "âœ… All pre-commit checks passed!"